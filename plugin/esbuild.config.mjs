import esbuild from "esbuild";
import process from "process";
import builtins from "builtin-modules";
import fs from "fs";
import path from "path";

const banner = `/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/
`;

const prod = process.argv[2] === "production";

// è°ƒè¯•ä¿¡æ¯ï¼šæ‰“å°å‚æ•°å’Œæ¨¡å¼
console.log("ğŸ“‹ æ„å»ºå‚æ•°:", process.argv);
console.log("ğŸ”§ æ„å»ºæ¨¡å¼:", prod ? "ç”Ÿäº§æ¨¡å¼ (production)" : "å¼€å‘æ¨¡å¼ (development)");

// ç»Ÿä¸€è¾“å‡ºåˆ°æ’ä»¶ç›®å½•ï¼Œç”±ç‹¬ç«‹åŒæ­¥è„šæœ¬å¤åˆ¶åˆ° Vault
const OUTPUT_DIR = ".";

console.log("ğŸ“ è¾“å‡ºç›®å½•:", OUTPUT_DIR);

const cssOutputPlugin = () => ({
	name: "css-output-plugin",
	setup(build) {
		build.onEnd(async (result) => {
			const file = build.initialOptions.outfile;
			// rename css file
			const parent = path.dirname(file);
			const cssFileName = path.join(parent, "main.css");
			const newCssFileName = path.join(parent, "styles.css");
			
			try {
				if (fs.existsSync(cssFileName)) {
					fs.renameSync(cssFileName, newCssFileName);
					console.log(`âœ… å·²é‡å‘½å CSS æ–‡ä»¶: ${newCssFileName}`);
				}
				
				// ç”Ÿäº§æ¨¡å¼ï¼šå¤åˆ¶ manifest.json åˆ°è¾“å‡ºç›®å½•
				if (prod) {
					const manifestSource = path.resolve("manifest.json");
					const manifestTarget = path.resolve(parent, "manifest.json");
					if (fs.existsSync(manifestSource) && manifestSource !== manifestTarget) {
						fs.copyFileSync(manifestSource, manifestTarget);
						console.log(`âœ… å·²å¤åˆ¶ manifest.json åˆ°: ${manifestTarget}`);
					}

					console.log(`\nğŸ‰ æ’ä»¶æ„å»ºå®Œæˆï¼Œäº§ç‰©ç›®å½•: ${path.resolve(parent)}`);
				}
			} catch (e) {
				console.error("âŒ CSS å¤„ç†å¤±è´¥:", e);
			}
		});
	},
});

const builtinExternals = [
	...builtins,
	...builtins.map((name) => `node:${name}`)
];

const context = await esbuild.context({
	banner: {
		js: banner,
	},
	entryPoints: ["src/main.ts"],
	bundle: true,
	plugins: [cssOutputPlugin()],
	external: [
		"obsidian",
		"electron",
		"@electron/remote",
		"@codemirror/autocomplete",
		"@codemirror/collab",
		"@codemirror/commands",
		"@codemirror/language",
		"@codemirror/lint",
		"@codemirror/search",
		"@codemirror/state",
		"@codemirror/view",
		"@lezer/common",
		"@lezer/highlight",
		"@lezer/lr",
		...builtinExternals,
	],
	format: "cjs",
	target: "es2018",
	logLevel: "info",
	sourcemap: prod ? false : "inline",
	treeShaking: true,
	outfile: path.join(OUTPUT_DIR, "main.js"),
	minify: prod,
});

if (!fs.existsSync(OUTPUT_DIR)) {
	fs.mkdirSync(OUTPUT_DIR, { recursive: true });
	console.log(`ğŸ“ åˆ›å»ºè¾“å‡ºç›®å½•: ${OUTPUT_DIR}`);
}

if (prod) {
	await context.rebuild();
	process.exit(0);
} else {
	await context.watch();
}
