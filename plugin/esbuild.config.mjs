import esbuild from "esbuild";
import process from "process";
import builtins from "builtin-modules";
import fs from "fs";
import path from "path";

const banner = `/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/
`;

const prod = process.argv[2] === "production";

// Obsidian æ’ä»¶ç›®æ ‡ç›®å½•
const OBSIDIAN_PLUGIN_DIR = "C:\\Desktop\\æ²™ç®±ä»“åº“2\\.obsidian\\plugins\\obsidian-flow-form";

// ç¡®å®šè¾“å‡ºç›®å½•ï¼šç”Ÿäº§æ¨¡å¼ç›´æ¥è¾“å‡ºåˆ° Obsidian æ’ä»¶ç›®å½•ï¼Œå¼€å‘æ¨¡å¼è¾“å‡ºåˆ°å½“å‰ç›®å½•
const OUTPUT_DIR = prod ? OBSIDIAN_PLUGIN_DIR : ".";

const cssOutputPlugin = () => ({
	name: "css-output-plugin",
	setup(build) {
		build.onEnd(async (result) => {
			const file = build.initialOptions.outfile;
			// rename css file
			const parent = path.dirname(file);
			const cssFileName = path.join(parent, "main.css");
			const newCssFileName = path.join(parent, "styles.css");
			
			try {
				if (fs.existsSync(cssFileName)) {
					fs.renameSync(cssFileName, newCssFileName);
					console.log(`âœ… å·²é‡å‘½å CSS æ–‡ä»¶: ${newCssFileName}`);
				}
				
				// ç”Ÿäº§æ¨¡å¼ï¼šå¤åˆ¶ manifest.json åˆ°è¾“å‡ºç›®å½•
				if (prod) {
					const manifestSource = "manifest.json";
					const manifestTarget = path.join(parent, "manifest.json");
					if (fs.existsSync(manifestSource)) {
						fs.copyFileSync(manifestSource, manifestTarget);
						console.log(`âœ… å·²å¤åˆ¶ manifest.json åˆ°: ${manifestTarget}`);
					}
					
					console.log(`\nğŸ‰ æ’ä»¶æ–‡ä»¶å·²ç›´æ¥æ„å»ºåˆ° Obsidian ç›®å½•: ${OBSIDIAN_PLUGIN_DIR}`);
				}
			} catch (e) {
				console.error("âŒ CSS å¤„ç†å¤±è´¥:", e);
			}
		});
	},
});

const context = await esbuild.context({
	banner: {
		js: banner,
	},
	entryPoints: ["src/main.ts"],
	bundle: true,
	plugins: [cssOutputPlugin()],
	external: [
		"obsidian",
		"electron",
		"@codemirror/autocomplete",
		"@codemirror/collab",
		"@codemirror/commands",
		"@codemirror/language",
		"@codemirror/lint",
		"@codemirror/search",
		"@codemirror/state",
		"@codemirror/view",
		"@lezer/common",
		"@lezer/highlight",
		"@lezer/lr",
		...builtins,
	],
	format: "cjs",
	target: "es2018",
	logLevel: "info",
	sourcemap: prod ? false : "inline",
	treeShaking: true,
	outfile: path.join(OUTPUT_DIR, "main.js"),
	minify: prod,
});

// ç”Ÿäº§æ¨¡å¼ï¼šç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
if (prod && !fs.existsSync(OUTPUT_DIR)) {
	fs.mkdirSync(OUTPUT_DIR, { recursive: true });
	console.log(`ğŸ“ åˆ›å»ºè¾“å‡ºç›®å½•: ${OUTPUT_DIR}`);
}

if (prod) {
	await context.rebuild();
	process.exit(0);
} else {
	await context.watch();
}
