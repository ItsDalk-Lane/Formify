# 文件内容上下文功能说明

## 功能概述

此功能允许用户在AI Chat聊天界面中选择文件和文件夹，并将其内容作为聊天上下文提供给AI模型，使AI能够基于这些文件内容进行回答和对话。

## 使用方法

1. **选择文件**：
   - 在聊天输入框中点击回形针图标
   - 选择"选择文件"选项
   - 在文件选择器中选择一个或多个文件
   - 选中的文件将显示在聊天输入框上方

2. **选择文件夹**：
   - 在聊天输入框中点击回形针图标
   - 选择"选择文件夹"选项
   - 在文件夹选择器中选择一个或多个文件夹
   - 选中的文件夹将显示在聊天输入框上方

3. **发送消息**：
   - 输入您的问题或消息
   - 点击发送按钮
   - AI将基于选中的文件和文件夹内容进行回答

## 功能特性

### 文件内容读取

- 支持读取Obsidian仓库中的各种文件类型
- 特别优化了Markdown文件(.md)的处理
- 自动识别文件类型并应用适当的语法高亮
- 支持常见编程语言文件（JavaScript、TypeScript、Python、Java等）

### 文件夹内容读取

- 递归读取文件夹中的所有文件
- 自动排除二进制文件和系统文件
- 支持文件过滤和大小限制
- 智能跳过不必要的目录（如node_modules、.git等）

### 内容处理

- 自动截断过长的文件内容，避免上下文过长
- 为每个文件添加清晰的标识和路径信息
- 将文件内容格式化为AI易于理解的格式
- 保留原始文件结构和层次关系

## 配置选项

### 文件内容读取选项

```typescript
interface FileContentOptions {
    maxFileSize?: number; // 最大文件大小（字节），默认1MB
    maxContentLength?: number; // 最大内容长度（字符），默认10000
    includeExtensions?: string[]; // 包含的文件扩展名，为空则包含所有
    excludeExtensions?: string[]; // 排除的文件扩展名
    excludePatterns?: RegExp[]; // 排除的文件路径模式
}
```

### 默认配置

- 最大文件大小：1MB
- 最大内容长度：10000个字符
- 包含所有文件类型
- 排除二进制文件：exe, dll, bin, zip, rar, tar, gz
- 排除路径模式：/node_modules/, /.git/, /.DS_Store/, /Thumbs.db/

## 技术实现

### 核心服务

1. **FileContentService**：负责读取文件和文件夹内容
2. **MessageService**：处理文件内容并将其整合到AI消息中
3. **ChatService**：协调文件内容读取和消息发送

### 文件内容格式化

文件内容被格式化为以下格式：

```
## 文件: 文件名 (路径: 文件路径)

```语言标识符
文件内容
```
```

文件夹内容被格式化为以下格式：

```
# 文件夹: 文件夹名 (路径: 文件夹路径)

包含 N 个文件:

## 文件: 文件1 (路径: 文件1路径)

```语言标识符
文件1内容
```

## 文件: 文件2 (路径: 文件2路径)

```语言标识符
文件2内容
```
```

## 使用场景

1. **代码分析**：选择代码文件，让AI分析代码结构或解释功能
2. **文档问答**：选择文档文件，让AI基于文档内容回答问题
3. **项目总结**：选择项目文件夹，让AI总结项目结构和功能
4. **学习辅助**：选择学习资料，让AI解释概念或回答相关问题

## 注意事项

1. 文件内容会被发送给AI模型，请确保不包含敏感信息
2. 大型文件夹可能需要较长时间处理，请耐心等待
3. 过多的文件可能导致上下文过长，影响AI回答质量
4. 某些特殊文件格式可能无法正确读取或显示

## 故障排除

### 文件无法读取

- 检查文件是否存在
- 确认文件大小是否超过限制
- 验证文件类型是否被排除

### 内容显示异常

- 检查文件编码是否为UTF-8
- 确认文件内容是否为文本格式
- 验证文件扩展名是否正确识别

### AI回答不准确

- 减少选择的文件数量
- 检查文件内容是否相关
- 尝试提供更具体的问题
