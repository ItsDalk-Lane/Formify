# 文件标签显示功能说明

## 功能概述

此功能改进了文件和文件夹在聊天界面中的显示方式，并在历史记录中保存文件和文件夹信息，使用户能够更清晰地了解哪些文件被用作AI对话的上下文。

## 功能改进

### 1. 用户消息中的文件/文件夹标签显示

在聊天界面中，用户发送的消息现在会显示其添加的文件和文件夹标签：

- **文件标签**：使用 `[[]]` 格式显示，例如 `[[文档.md]]`（只显示文件名，不显示完整路径）
- **文件夹标签**：使用 `#` 前缀显示，例如 `#项目文件夹`

这些标签直接显示在用户消息内容的下方，不再添加"**附件:**"标题。

### 2. 历史记录中的文件/文件夹信息

在保存聊天历史记录时，文件和文件夹信息会以以下方式保存：

- **文件路径**：使用 `[[]]` 包裹，只包含文件名，例如 `[[需求分析.md]]`
- **文件夹路径**：使用 `#` 前缀，例如 `#项目文件夹`

### 3. 历史记录元数据中的文件/文件夹标签

在历史记录文件的frontmatter中，添加的文件和文件夹标签会记录在`contextNotes`属性中：

```yaml
---
id: chat-uuid
title: 聊天标题
model: gpt-4
created: 2023-11-26 10:30:00
updated: 2023-11-26 10:35:00
messageCount: 5
contextNotes:
  - [[文档1.md]]  # 只包含文件名，不包含路径
  - 文件夹路径  # 文件夹路径不包含#符号
---
```

### 4. 移除Relevant Notes显示

加载历史记录时，不再显示"Relevant context provided by the user:"区域，避免界面混乱。

在`ChatMessages.tsx`中，注释掉了`<RelevantNotes notes={contextNotes} />`组件，完全移除了"Relevant Notes"区域的显示：

```typescript
return (
  <div className={containerClasses}>
    {/* 注释掉RelevantNotes组件，不再显示"Relevant Notes"区域 */}
    {/* <RelevantNotes notes={contextNotes} /> */}
    <div
      ref={scrollRef}
      className="tw-flex tw-flex-1 tw-flex-col tw-overflow-y-auto tw-scroll-smooth tw-select-text tw-break-words tw-gap-2"
    >
      {messages.map((message, index) => (
        <MessageItem
          key={message.id}
          message={message}
          service={service}
          isGenerating={message.role === 'assistant' && index === messages.length - 1 && state.isGenerating}
        />
      ))}
    </div>
  </div>
);
```

## 使用示例

### 选择文件和文件夹

1. 在聊天输入框中点击回形针图标
2. 选择"选择文件"或"选择文件夹"
3. 在选择器中选择文件或文件夹
4. 选中的文件和文件夹会显示在输入框上方

### 发送消息

1. 输入您的问题
2. 点击发送按钮
3. 消息会显示文件和文件夹标签，格式简洁

### 查看历史记录

1. 打开保存的聊天历史文件
2. 用户消息下方会显示文件和文件夹标签
3. frontmatter中的contextNotes会包含所有添加的文件和文件夹
4. 不会显示"Relevant context provided by the user:"区域

## 技术实现

### 消息序列化

`MessageService.serializeMessage`方法已更新，支持在用户消息中包含文件和文件夹信息：

```typescript
serializeMessage(message: ChatMessage, selectedFiles?: SelectedFile[], selectedFolders?: SelectedFolder[]): string {
  // ...原有代码...
  
  // 如果是用户消息且有选中的文件或文件夹，添加文件和文件夹信息
  if (message.role === 'user' && (selectedFiles || selectedFolders)) {
    const fileTags = [];
    const folderTags = [];
    
    // 处理文件标签 - 只包含文件名，不包含路径
    if (selectedFiles && selectedFiles.length > 0) {
      for (const file of selectedFiles) {
        fileTags.push(`[[${file.name}]]`); // 只使用文件名，不使用路径
      }
    }
    
    // 处理文件夹标签
    if (selectedFolders && selectedFolders.length > 0) {
      for (const folder of selectedFolders) {
        folderTags.push(`#${folder.path}`);
      }
    }
    
    // 添加文件和文件夹标签到消息中，不添加"附件:"标题
    if (fileTags.length > 0 || folderTags.length > 0) {
      const allTags = [...fileTags, ...folderTags].join(' ');
      fullMessage += `\n\n${allTags}`;
    }
  }
  
  // ...原有代码...
}
```

### 历史记录保存

`HistoryService`中的方法已更新，支持文件和文件夹信息的保存：

1. `appendMessageToFile`：追加消息时包含文件和文件夹信息
2. `createNewSessionFileWithFirstMessage`：创建新会话文件时包含文件和文件夹信息
3. `updateFileTimestamp`：更新文件时间戳时同时更新文件和文件夹信息

### 移除Relevant Notes显示

在`MessageService.toProviderMessages`方法中，注释掉了创建"Relevant context provided by the user:"消息的代码：

```typescript
// 不再显示contextNotes作为Relevant context，因为文件和文件夹信息已经在processFileAndFolderContent中处理
// if (contextNotes.length > 0) {
// 	providerMessages.push({
// 		role: 'system',
// 		content: `Relevant context provided by the user:\n${contextNotes.map((note, index) => `${index + 1}. ${note}`).join('\n')}`
// 	});
// }
```

## 优势

1. **简洁显示**：文件标签只显示文件名，不显示完整路径，更加简洁
2. **历史追踪**：历史记录中保留了文件和文件夹信息，便于回顾
3. **元数据记录**：frontmatter中的contextNotes便于搜索和过滤
4. **格式一致**：文件使用`[[]]`格式，文件夹使用`#`前缀，与Obsidian惯例一致
5. **避免重复**：确保文件/文件夹标签在历史记录中只显示一次
6. **界面清爽**：不再显示"Relevant context provided by the user:"区域，避免界面混乱

## 注意事项

1. 文件和文件夹标签只会在用户消息中显示，不会在AI消息中显示
2. 历史记录中的文件和文件夹信息会累积保存，不会重复添加相同的标签
3. 文件和文件夹标签不会影响AI的回复内容，只是用于显示和记录
4. 如果文件或文件夹被删除，标签仍然会保留在历史记录中
5. 在contextNotes中，文件夹路径不包含#符号，只在消息正文中添加
6. 文件标签只包含文件名，不包含完整路径
7. 不再显示"Relevant context provided by the user:"区域
