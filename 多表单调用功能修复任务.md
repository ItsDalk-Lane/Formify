# 修复任务提示词

## 背景说明

当前项目中，表单动作系统支持在动作列表中配置"按钮动作-提交表单"类型的动作，用于打开并提交其他表单。动作链执行器（`IActionService.ts` 中的 `ActionChain` 类）负责按顺序依次执行表单配置的所有动作。

当表单的动作列表中包含多个"调用表单"动作时，当前实现存在严重问题：所有被调用的表单几乎同时创建并打开，但用户只能看到最后一个表单界面，前面的表单根本没有出现。这是因为 `ButtonActionService.submitForm()` 方法调用 `FormService.openForm()` 后，`openForm()` 方法创建模态框但不等待用户操作就立即返回，导致动作链继续执行下一个"调用表单"动作。

相比之下，`GenerateFormActionService`（生成表单动作）正确实现了等待用户输入的逻辑，使用 Promise 等待用户操作完成后再继续执行动作链。

## 问题描述

当在同一个表单的动作列表中配置多个"按钮动作-提交表单"类型的动作时，存在以下问题：

**问题表现**：
- 只有最后一个动作对应的表单会被完整执行（显示界面、接受用户输入、提交并执行其动作链）
- 其余动作对应的表单既不显示界面，也不执行（这些表单的打开和提交逻辑都没有被正确触发）
- 无论被调用的表单是否配置了执行超时控制，结果都一样

**问题严重性**：
这导致用户配置的多个"调用表单"动作中，只有最后一个能够生效，前面的所有动作都被忽略了，严重破坏了表单动作链的预期执行逻辑。

**根本原因**：
`ButtonActionService.ts` 中的 `submitForm()` 方法（第 108-132 行）调用 `formService.openForm(formConfig, app)` 后，该方法立即返回而不等待用户操作完成。`FormService.ts` 中的 `openForm()` 方法（第 174-190 行）调用 `FormViewModal2.open()` 后也不等待用户输入。这导致多个表单模态框几乎同时创建并渲染到页面中，由于 React 的渲染机制和 Radix UI Dialog 的行为，最终只有最后一个模态框能够正确显示和交互，前面的模态框被覆盖或状态异常。

**触发条件**：
- 在表单的动作列表中配置了多个"按钮动作-提交表单"类型的动作
- 用户提交表单，触发动作链执行

## 期望行为

需要实现两种执行模式和两种界面模式的组合配置：

**1. 依次执行模式**（默认行为）：
- 每个表单提交后，其内部的动作链完整执行完成，才开始下一个表单的打开和执行
- 界面模式可选：
  - **逐个打开**：第一个表单打开 → 用户填写并提交 → 第一个表单关闭 → 第二个表单打开 → ...
  - **合并显示**：所有表单的字段合并到一个模态框中显示，每个表单的字段区域有清晰的标题或标识区分，用户填写完毕后一次性提交，提交后动作链按顺序依次执行每个表单的动作

**2. 同时执行模式**（可选配置）：
- 所有表单的界面合并显示（强制使用合并显示，不支持逐个打开）
- 用户一次性提交所有表单后，所有表单的动作链同时并行执行

**配置方式**：
需要在按钮动作配置中添加两个选项：
- 执行模式：依次执行 / 同时执行
- 界面模式：逐个打开 / 合并显示（当执行模式选择"同时执行"时，此选项自动锁定为"合并显示"）

## 验收标准

1. 修复后，当表单动作列表中包含多个"调用表单"动作时，所有配置的表单都应该能够正确打开和执行
2. 支持依次执行 + 逐个打开模式：表单按顺序逐个显示，每个表单的动作链完整执行完成后才打开下一个表单
3. 支持依次执行 + 合并显示模式：所有表单字段合并到一个模态框显示，用户一次性提交后，各表单的动作链按顺序依次执行
4. 支持同时执行 + 合并显示模式：所有表单字段合并显示，用户提交后，所有表单的动作链并行执行
5. 当执行模式选择"同时执行"时，界面模式选项应自动锁定为"合并显示"且不可修改
6. 合并显示模式下，每个表单的字段区域应有清晰的标题或标识，让用户能够区分哪些字段属于哪个表单
7. 修复应参考 `GenerateFormActionService` 的实现方式，使用 Promise 正确等待用户操作完成
8. 修复后应保持向下兼容性，不影响其他类型动作的正常执行
9. 修复后不应破坏现有的执行超时控制、停止按钮等功能的正常运行

## 边界情况和兼容性要求

1. 需要考虑被调用表单中可能包含的动作类型（AI动作、文件操作、命令调用等），确保在各种动作类型下都能正确执行
2. 需要考虑被调用表单的"是否需要显示界面"规则（通过 `FormDisplayRules.shouldShowForm()` 判断），对于不需要显示界面的表单，应直接在后台提交并执行其动作链
3. 需要考虑被调用表单执行过程中可能出现的错误或中断情况，确保错误处理和状态恢复的正确性
4. 需要考虑动作链的执行顺序，确保在依次执行模式下，前一个表单的所有动作（包括异步动作）都完成后才开始下一个表单的执行
5. 需要考虑并发执行时的资源竞争问题，特别是在同时执行模式下，多个表单的动作链可能同时操作文件或调用命令
6. 需要保持向下兼容性，对于未配置新选项的现有按钮动作，应默认使用"依次执行 + 逐个打开"模式，保持原有的用户期望行为
7. 如果被调用的表单本身也包含"调用表单"动作（嵌套调用），需要确保执行逻辑的正确性，避免无限递归或状态混乱
8. 修复时应最小化对现有代码的改动范围，优先扩展现有代码而非创建新的复杂架构
9. 需要确保 `FormExecutionManager` 单例在多个表单依次执行时的状态管理正确，避免前一个表单的执行状态影响后续表单
